<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Computer Use - ÈÅ†Á´ØÁÄèË¶ΩÂô®ÊéßÂà∂</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        
        #canvas {
            display: block;
            cursor: pointer;
            width: 100vw;
            height: 100vh;
            object-fit: contain;
        }
        
        #canvas.ai-mode {
            pointer-events: none;
            opacity: 0.9;
        }
        
        /* Status indicators */
        #status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            backdrop-filter: blur(10px);
            z-index: 1000;
        }
        
        #mode-indicator {
            position: fixed;
            top: 50px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: none;
        }
        
        #mode-indicator.human {
            background: rgba(34, 197, 94, 0.8);
            display: block;
        }
        
        #mode-indicator.ai {
            background: rgba(59, 130, 246, 0.8);
            display: block;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        /* AI Chat Panel */
        #ai-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        #ai-panel:not(.collapsed) {
            width: 400px;
        }
        
        #ai-panel.collapsed {
            width: 50px !important;
        }
        
        #ai-panel-content {
            max-height: 500px;
            background: rgba(0, 0, 0, 0.9);
            border-radius: 12px;
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
        
        #ai-panel.collapsed #ai-panel-content {
            display: none !important;
        }
        
        #ai-panel.collapsed #ai-toggle {
            background: rgba(249, 115, 22, 0.9);
            border: 2px solid rgba(255, 255, 255, 0.3);
            font-weight: bold;
            font-size: 20px;
        }
        
        #ai-header {
            padding: 12px 16px;
            padding-right: 60px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #ai-header h3 {
            color: white;
            font-size: 14px;
            font-weight: 600;
        }
        
        #ai-toggle {
            position: absolute;
            top: 50%;
            right: 16px;
            transform: translateY(-50%);
            background: rgba(59, 130, 246, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 18px;
            padding: 6px 10px;
            transition: all 0.2s;
            z-index: 1001;
        }
        
        #ai-toggle:hover {
            background: rgba(59, 130, 246, 0.5);
            transform: translateY(-50%) scale(1.05);
        }
        
        #ai-messages {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            max-height: 350px;
        }
        
        .ai-message {
            margin-bottom: 12px;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 13px;
            line-height: 1.5;
        }
        
        .ai-message.user {
            background: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
            text-align: right;
        }
        
        .ai-message.assistant {
            background: rgba(34, 197, 94, 0.2);
            color: #86efac;
        }
        
        .ai-message.system {
            background: rgba(156, 163, 175, 0.2);
            color: #d1d5db;
            font-size: 11px;
            text-align: center;
        }
        
        .ai-message.error {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }
        
        #ai-input-container {
            padding: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 8px;
        }
        
        .mode-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .mode-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        .mode-btn.active {
            background: rgba(34, 197, 94, 0.8);
            border-color: rgba(34, 197, 94, 0.8);
            color: white;
        }
        
        #ai-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 8px 12px;
            color: white;
            font-size: 13px;
            outline: none;
        }
        
        #ai-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }
        
        #ai-input:focus {
            border-color: rgba(59, 130, 246, 0.5);
            background: rgba(255, 255, 255, 0.15);
        }
        
        #ai-send, #ai-stop {
            background: rgba(59, 130, 246, 0.8);
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            color: white;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        #ai-send:hover {
            background: rgba(59, 130, 246, 1);
        }
        
        #ai-stop {
            background: rgba(239, 68, 68, 0.8);
            display: none;
        }
        
        #ai-stop:hover {
            background: rgba(239, 68, 68, 1);
        }
        
        #ai-stop.active {
            display: block;
        }
        
        .connected {
            color: #4ade80;
        }
        
        .disconnected {
            color: #f87171;
        }
        
        /* Minimize/Maximize */
        #ai-panel.minimized #ai-messages,
        #ai-panel.minimized #ai-input-container {
            display: none;
        }
        
        #ai-panel.minimized {
            max-height: 50px;
        }
        
        #ai-header {
            flex-shrink: 0;
        }
        
        /* URL Control Panel */
        #url-control {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1000;
        }
        
        #url-control:not(.collapsed) {
            max-width: 600px;
        }
        
        #url-control-content {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 8px;
            border-radius: 8px;
            display: flex;
            gap: 6px;
            align-items: center;
        }
        
        #url-control.collapsed {
            width: 40px !important;
            max-width: 40px !important;
        }
        
        #url-control.collapsed #url-control-content {
            display: none !important;
        }
        
        #url-toggle {
            position: absolute;
            left: 0;
            background: rgba(249, 115, 22, 0.9);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 8px 12px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 40px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            z-index: 1001;
        }
        
        #url-toggle:hover {
            background: rgba(249, 115, 22, 1);
            transform: scale(1.05);
        }
        
        #url-control-content {
            margin-left: 52px;
        }
        
        #url-control button {
            background: rgba(59, 130, 246, 0.8);
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
            min-width: 36px;
        }
        
        #url-control button:hover:not(:disabled) {
            background: rgba(59, 130, 246, 1);
        }
        
        #url-control button:disabled {
            background: rgba(100, 100, 100, 0.5);
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        #btn-back, #btn-forward {
            font-weight: bold;
        }
        
        #url-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 8px 12px;
            color: white;
            font-size: 13px;
            outline: none;
            min-width: 300px;
        }
        
        #url-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }
        
        #url-input:focus {
            border-color: rgba(59, 130, 246, 0.5);
            background: rgba(255, 255, 255, 0.15);
        }
        
        #btn-go {
            background: rgba(34, 197, 94, 0.8);
        }
        
        #btn-go:hover {
            background: rgba(34, 197, 94, 1);
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <div id="status" class="disconnected">üî¥ Êú™ÈÄ£Êé•</div>
    <div id="mode-indicator">üë§ ‰∫∫È°ûÊéßÂà∂</div>
    
    <!-- URL Control Panel -->
    <div id="url-control">
        <button id="url-toggle" title="Êî∂Á∏Æ/Â±ïÈñã">‚ò∞</button>
        <div id="url-control-content">
            <button id="btn-back" title="‰∏ä‰∏ÄÈ†Å">‚óÄ</button>
            <button id="btn-forward" title="‰∏ã‰∏ÄÈ†Å">‚ñ∂</button>
            <input type="text" id="url-input" placeholder="Ëº∏ÂÖ•Á∂≤ÂùÄÂæåÊåâ Enter (‰æãÂ¶Ç: https://www.google.com)" />
        </div>
    </div>
    
    <!-- AI Chat Panel -->
    <div id="ai-panel">
        <button id="ai-toggle">‚àí</button>
        <div id="ai-panel-content">
            <div id="ai-header">
                <h3>ü§ñ AI Âä©Êâã</h3>
                <div style="display: flex; gap: 4px; margin-top: 8px;">
                    <button id="mode-computer-use" class="mode-btn active" style="font-size: 10px; padding: 4px 8px;">Computer Use</button>
                    <button id="mode-browser-use" class="mode-btn" style="font-size: 10px; padding: 4px 8px;">Browser Use</button>
                </div>
            </div>
            <div id="ai-messages"></div>
            <div id="ai-input-container">
                <input type="text" id="ai-input" placeholder="Ëº∏ÂÖ• AI Êåá‰ª§...Ôºà‰æãÂ¶ÇÔºöÊêúÂ∞ãÂè∞ÁÅ£Â§©Ê∞£Ôºâ" />
                <button id="ai-send">ÁôºÈÄÅ</button>
                <button id="ai-stop">ÂÅúÊ≠¢</button>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const statusEl = document.getElementById('status');
        const modeIndicator = document.getElementById('mode-indicator');
        const aiPanel = document.getElementById('ai-panel');
        const aiMessages = document.getElementById('ai-messages');
        const aiInput = document.getElementById('ai-input');
        const aiSend = document.getElementById('ai-send');
        const aiStop = document.getElementById('ai-stop');
        const aiToggle = document.getElementById('ai-toggle');
        const urlInput = document.getElementById('url-input');
        const btnBack = document.getElementById('btn-back');
        const btnForward = document.getElementById('btn-forward');
        const urlToggle = document.getElementById('url-toggle');
        const urlControl = document.getElementById('url-control');
        
        let ws = null;
        let currentUrl = '';
        let currentMode = 'idle';
        let aiRunning = false;
        let browserUseRunning = false;
        let aiMode = 'computer-use'; // 'computer-use' or 'browser-use'
        let isEditingUrl = false;
        
        // ÈÄ£Êé• WebSocket
        function connect() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host || 'localhost:8000';
            ws = new WebSocket(`${protocol}//${host}/ws/screenshot`);
            
            ws.onopen = () => {
                console.log('‚úÖ WebSocket Â∑≤ÈÄ£Êé•');
                statusEl.textContent = 'üü¢ Â∑≤ÈÄ£Êé•';
                statusEl.className = 'connected';
            };
            
            ws.onclose = () => {
                console.log('‚ùå WebSocket Â∑≤Êñ∑Á∑ö');
                statusEl.textContent = 'üî¥ Êú™ÈÄ£Êé•';
                statusEl.className = 'disconnected';
                
                // 3 ÁßíÂæåËá™ÂãïÈáçÈÄ£
                setTimeout(connect, 3000);
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket ÈåØË™§:', error);
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
        }
        
        // ËôïÁêÜ WebSocket Ë®äÊÅØ
        function handleWebSocketMessage(data) {
            switch(data.type) {
                case 'screenshot':
                    updateCanvas(data);
                    break;
                    
                case 'ai_status':
                    handleAIStatus(data);
                    break;
                    
                case 'ai_message':
                    addAIMessage(data.message, 'assistant');
                    break;
                    
                case 'ai_action':
                    addAIMessage(`üé¨ Âü∑Ë°åÂãï‰Ωú: ${data.action} (Á¨¨ ${data.iteration} Ê¨°)`, 'system');
                    break;
                    
                case 'browser_use_status':
                    handleBrowserUseStatus(data);
                    break;
                    
                case 'browser_use_message':
                    addAIMessage(data.message, data.status === 'error' ? 'error' : 'assistant');
                    break;
                    
                case 'state':
                    currentMode = data.mode;
                    aiRunning = data.ai_running;
                    browserUseRunning = data.browser_use_running;
                    updateModeIndicator();
                    break;
            }
        }
        
        // Êõ¥Êñ∞ Canvas
        function updateCanvas(data) {
            const img = new Image();
            img.onload = () => {
                canvas.width = data.width;
                canvas.height = data.height;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, data.width, data.height);
                
                if (data.url) {
                    currentUrl = data.url;
                    // Âè™Âú®Áî®Êà∂Ê≤íÊúâÁ∑®ËºØÊôÇÊõ¥Êñ∞ URL Ëº∏ÂÖ•Ê°Ü
                    if (!isEditingUrl) {
                        urlInput.value = data.url;
                    }
                }
                
                currentMode = data.mode;
                updateModeIndicator();
            };
            img.src = 'data:image/png;base64,' + data.image;
        }
        
        // Êõ¥Êñ∞Ê®°ÂºèÊåáÁ§∫Âô®
        function updateModeIndicator() {
            if (currentMode === 'ai' || aiRunning) {
                modeIndicator.textContent = 'ü§ñ Computer Use ÊéßÂà∂‰∏≠';
                modeIndicator.className = 'ai';
                canvas.classList.add('ai-mode');
            } else if (currentMode === 'browser-use' || browserUseRunning) {
                modeIndicator.textContent = 'üåê Browser Use ÊéßÂà∂‰∏≠';
                modeIndicator.className = 'ai';
                canvas.classList.add('ai-mode');
            } else if (currentMode === 'human') {
                modeIndicator.textContent = 'üë§ ‰∫∫È°ûÊéßÂà∂';
                modeIndicator.className = 'human';
                canvas.classList.remove('ai-mode');
            } else {
                modeIndicator.style.display = 'none';
                canvas.classList.remove('ai-mode');
            }
        }
        
        // ËôïÁêÜ AI ÁãÄÊÖã
        function handleAIStatus(data) {
            if (data.status === 'starting') {
                aiRunning = true;
                aiSend.style.display = 'none';
                aiStop.classList.add('active');
                addAIMessage(`üöÄ ÈñãÂßãÂü∑Ë°å: ${data.task}`, 'system');
            } else if (data.status === 'stopped') {
                aiRunning = false;
                aiSend.style.display = 'block';
                aiStop.classList.remove('active');
                addAIMessage('‚èπ AI Â∑≤ÂÅúÊ≠¢', 'system');
            }
            updateModeIndicator();
        }
        
        function handleBrowserUseStatus(data) {
            if (data.status === 'starting') {
                browserUseRunning = true;
                aiSend.style.display = 'none';
                aiStop.classList.add('active');
                addAIMessage(`üöÄ Browser-use ÈñãÂßãÂü∑Ë°å: ${data.task}`, 'system');
            } else if (data.status === 'stopped') {
                browserUseRunning = false;
                aiSend.style.display = 'block';
                aiStop.classList.remove('active');
                addAIMessage('‚èπ Browser-use Â∑≤ÂÅúÊ≠¢', 'system');
            }
            updateModeIndicator();
        }
        
        // Ê∑ªÂä† AI Ë®äÊÅØ
        function addAIMessage(message, type = 'assistant') {
            const msgDiv = document.createElement('div');
            msgDiv.className = `ai-message ${type}`;
            msgDiv.textContent = message;
            aiMessages.appendChild(msgDiv);
            aiMessages.scrollTop = aiMessages.scrollHeight;
        }
        
        // ÁôºÈÄÅ AI Êåá‰ª§
        function sendAICommand() {
            const task = aiInput.value.trim();
            if (!task || !ws || ws.readyState !== WebSocket.OPEN) return;
            
            if (aiRunning || browserUseRunning) return;
            
            addAIMessage(task, 'user');
            
            if (aiMode === 'browser-use') {
                ws.send(JSON.stringify({
                    type: 'browser_use_start',
                    task: task
                }));
            } else {
                ws.send(JSON.stringify({
                    type: 'ai_start',
                    task: task
                }));
            }
            
            aiInput.value = '';
        }
        
        // ÂÅúÊ≠¢ AI
        function stopAI() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            
            if (browserUseRunning) {
                ws.send(JSON.stringify({
                    type: 'browser_use_stop'
                }));
            } else {
                ws.send(JSON.stringify({
                    type: 'ai_stop'
                }));
            }
        }
        
        // ÁôºÈÄÅÊìç‰ΩúÂà∞ÂæåÁ´Ø
        function sendAction(type, data) {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            ws.send(JSON.stringify({ type, ...data }));
        }
        
        // ÊªëÈº†ÈªûÊìä
        canvas.addEventListener('click', (e) => {
            if (aiRunning || browserUseRunning) return; // AI ÊéßÂà∂ÊôÇÁ¶ÅÁî®
            
            const rect = canvas.getBoundingClientRect();
            const imgAspect = canvas.width / canvas.height;
            const viewAspect = rect.width / rect.height;
            
            let displayWidth, displayHeight, offsetX, offsetY;
            
            if (viewAspect > imgAspect) {
                displayHeight = rect.height;
                displayWidth = rect.height * imgAspect;
                offsetX = (rect.width - displayWidth) / 2;
                offsetY = 0;
            } else {
                displayWidth = rect.width;
                displayHeight = rect.width / imgAspect;
                offsetX = 0;
                offsetY = (rect.height - displayHeight) / 2;
            }
            
            const clickX = e.clientX - rect.left - offsetX;
            const clickY = e.clientY - rect.top - offsetY;
            
            if (clickX < 0 || clickX > displayWidth || clickY < 0 || clickY > displayHeight) {
                return;
            }
            
            const x = Math.round((clickX / displayWidth) * canvas.width);
            const y = Math.round((clickY / displayHeight) * canvas.height);
            
            console.log(`ÈªûÊìä: (${x}, ${y})`);
            sendAction('click', { x, y });
        });
        
        // ÈçµÁõ§‰∫ã‰ª∂
        document.addEventListener('keydown', (e) => {
            // Â¶ÇÊûúÁÑ¶ÈªûÂú®Ëº∏ÂÖ•Ê°ÜÔºå‰∏çÊîîÊà™
            if (document.activeElement === aiInput || document.activeElement === urlInput) return;
            
            // ÂÖÅË®± F5 Âíå F12
            if (e.key === 'F5' || e.key === 'F12') return;
            
            // AI ÊéßÂà∂ÊôÇÁ¶ÅÁî®
            if (aiRunning) {
                e.preventDefault();
                return;
            }
            
            e.preventDefault();
            
            sendAction('keypress', {
                key: e.key,
                ctrl: e.ctrlKey || e.metaKey,
                shift: e.shiftKey,
                alt: e.altKey
            });
        });
        
        // ÊªæËº™ÊªæÂãï
        canvas.addEventListener('wheel', (e) => {
            if (aiRunning) return; // AI ÊéßÂà∂ÊôÇÁ¶ÅÁî®
            
            e.preventDefault();
            sendAction('scroll', { deltaY: e.deltaY });
        }, { passive: false });
        
        // AI Ëº∏ÂÖ•‰∫ã‰ª∂
        aiSend.addEventListener('click', sendAICommand);
        aiStop.addEventListener('click', stopAI);
        aiInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendAICommand();
        });
        
        // AI Ê®°ÂºèÂàáÊèõÊåâÈàï‰∫ã‰ª∂
        document.getElementById('mode-computer-use').addEventListener('click', () => {
            aiMode = 'computer-use';
            document.getElementById('mode-computer-use').classList.add('active');
            document.getElementById('mode-browser-use').classList.remove('active');
        });
        
        document.getElementById('mode-browser-use').addEventListener('click', () => {
            aiMode = 'browser-use';
            document.getElementById('mode-browser-use').classList.add('active');
            document.getElementById('mode-computer-use').classList.remove('active');
        });
        
        // AI Èù¢ÊùøÊî∂Á∏Æ/Â±ïÈñã
        aiToggle.addEventListener('click', () => {
            aiPanel.classList.toggle('collapsed');
            aiToggle.textContent = aiPanel.classList.contains('collapsed') ? '‚ñ∂' : '‚àí';
        });
        
        // URL ÊéßÂà∂ÂäüËÉΩ
        function navigateToUrl() {
            const url = urlInput.value.trim();
            if (!url || !ws || ws.readyState !== WebSocket.OPEN) return;
            
            // Ëá™ÂãïÊ∑ªÂä† https:// Â¶ÇÊûúÊ≤íÊúâÂçîË≠∞
            let fullUrl = url;
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                fullUrl = 'https://' + url;
            }
            
            ws.send(JSON.stringify({
                type: 'navigate',
                url: fullUrl
            }));
            
            // ÁßªÈô§ÁÑ¶Èªû
            urlInput.blur();
        }
        
        function goBack() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            ws.send(JSON.stringify({ type: 'back' }));
        }
        
        function goForward() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            ws.send(JSON.stringify({ type: 'forward' }));
        }
        
        // ËøΩËπ§ URL Ëº∏ÂÖ•Ê°ÜÁ∑®ËºØÁãÄÊÖã
        urlInput.addEventListener('focus', () => {
            isEditingUrl = true;
        });
        urlInput.addEventListener('blur', () => {
            isEditingUrl = false;
        });
        urlInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                navigateToUrl();
            }
        });
        btnBack.addEventListener('click', goBack);
        btnForward.addEventListener('click', goForward);
        
        // URL ÊéßÂà∂Èù¢ÊùøÊî∂Á∏Æ/Â±ïÈñã
        urlToggle.addEventListener('click', () => {
            urlControl.classList.toggle('collapsed');
            urlToggle.textContent = urlControl.classList.contains('collapsed') ? '‚ñ∂' : '‚ò∞';
        });
        
        // ÂïüÂãïÈÄ£Êé•
        connect();
        
        // Ëá™ÂãïËÅöÁÑ¶ Canvas
        canvas.focus();
        canvas.setAttribute('tabindex', '0');
    </script>
</body>
</html>
