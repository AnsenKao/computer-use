# Azure DevOps Pipeline for MyAgents Backend
trigger:
- master

pool:
  vmImage: 'ubuntu-latest'

variables:
  # ACR è¨­å®š
  acrName: 'openaiacr'
  acrLoginServer: '$(acrName).azurecr.io'
  
  # æ˜ åƒæª”è¨­å®š
  imageName: 'computer-use'
  imageTag: 'v$(Build.BuildId)'
  latestTag: 'latest'
  
  # Container App è¨­å®š
  containerAppName: 'browser-server-prod'
  resourceGroupName: 'langfuse-rg'
  
  # Dockerfile è·¯å¾‘
  dockerfilePath: 'Dockerfile'

stages:
# CI Stage - Build and Push Image
- stage: CI
  displayName: 'Continuous Integration'
  jobs:
  - job: BuildAndPush
    displayName: 'Build Docker Image and Push to ACR'
    steps:
    
    # æª¢å‡ºç¨‹å¼ç¢¼
    - checkout: self
      displayName: 'Checkout Source Code'
    
    # é©—è­‰å¿…è¦æª”æ¡ˆå­˜åœ¨
    - script: |
        echo "Checking required files..."
        ls -la
        
        # æª¢æŸ¥ Dockerfile
        if [ ! -f "Dockerfile" ]; then
          echo "âŒ Dockerfile not found"
          exit 1
        fi
        
        # æª¢æŸ¥ requirements.txt
        if [ ! -f "requirements.txt" ]; then
          echo "âŒ requirements.txt not found"
          exit 1
        fi
        
        # æª¢æŸ¥ä¸»ç¨‹å¼
        if [ ! -f "computer_use_backend.py" ]; then
          echo "âŒ computer_use_backend.py not found"
          exit 1
        fi
        
        # æª¢æŸ¥ static ç›®éŒ„å’Œ index.html
        if [ ! -d "static" ]; then
          echo "âŒ static directory not found"
          exit 1
        fi
        
        if [ ! -f "static/index.html" ]; then
          echo "âŒ static/index.html not found"
          exit 1
        fi
        
        echo "âœ… All required files found"
        echo "ğŸ“‹ Project structure:"
        tree -L 2 || ls -R
      displayName: 'Validate Required Files'
    
    # ä½¿ç”¨ AzureCLI å»ºç«‹å’Œæ¨é€ Docker æ˜ åƒæª”
    - task: AzureCLI@2
      displayName: 'Build and Push Docker Image'
      inputs:
        azureSubscription: 'AUO-OpenAI-OpenAI-Service-ImageMeasure-Infra-Config-ADTEC3'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "Logging into ACR..."
          az acr login --name $(acrName)
          
          echo "Building Docker image..."
          docker build -t $(acrLoginServer)/$(imageName):$(imageTag) \
                       -t $(acrLoginServer)/$(imageName):$(latestTag) \
                       --no-cache --progress=plain \
                       -f $(dockerfilePath) .
          
          echo "Pushing Docker image..."
          docker push $(acrLoginServer)/$(imageName):$(imageTag)
          docker push $(acrLoginServer)/$(imageName):$(latestTag)
          
          echo "âœ… Build and push completed"
    
    # ç°¡åŒ–çš„æ˜ åƒæª”é©—è­‰ (è·³éå®¹å™¨æ¸¬è©¦ï¼Œå› ç‚ºéœ€è¦æ•¸æ“šåº«é€£æ¥)
    - task: AzureCLI@2
      displayName: 'Verify Image Push'
      inputs:
        azureSubscription: 'AUO-OpenAI-OpenAI-Service-ImageMeasure-Infra-Config-ADTEC3'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "Verifying image push to ACR..."
          az acr repository show-tags --name $(acrName) --repository $(imageName) --output table
          
          echo "Checking specific tag: $(imageTag)"
          # ç°¡åŒ–é©—è­‰ - åªæª¢æŸ¥æ¨™ç±¤æ˜¯å¦å­˜åœ¨æ–¼åˆ—è¡¨ä¸­
          if az acr repository show-tags --name $(acrName) --repository $(imageName) | grep -q "$(imageTag)"; then
            echo "âœ… Image $(imageName):$(imageTag) successfully pushed to ACR"
            echo "ğŸ“‹ Available tags:"
            az acr repository show-tags --name $(acrName) --repository $(imageName) --output table
          else
            echo "âŒ Failed to verify image $(imageName):$(imageTag) in ACR"
            echo "Available tags:"
            az acr repository show-tags --name $(acrName) --repository $(imageName) --output table
            exit 1
          fi

# CD Stage - Deploy to Container Apps
- stage: CD
  displayName: 'Continuous Deployment'
  dependsOn: CI
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
  jobs:
  - job: DeployToContainerApps
    displayName: 'Deploy to Azure Container Apps'
    steps:
    
    # éƒ¨ç½²åˆ° Azure Container Apps
    - task: AzureCLI@2
      displayName: 'Update Container App'
      inputs:
        azureSubscription: 'AUO-OpenAI-OpenAI-Service-ImageMeasure-Infra-Config-ADTEC3'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "Updating Container App: $(containerAppName)"
          echo "New Image: $(acrLoginServer)/$(imageName):$(imageTag)"
          
          # æ›´æ–° Container App ä½¿ç”¨æ–°çš„æ˜ åƒæª”
          az containerapp update \
            --name $(containerAppName) \
            --resource-group $(resourceGroupName) \
            --image $(acrLoginServer)/$(imageName):$(imageTag) \
            --output table
          
          echo "âœ… Container App update command completed"
    
    # ç­‰å¾…éƒ¨ç½²å®Œæˆ
    - script: |
        echo "Waiting for deployment to complete..."
        sleep 60
      displayName: 'Wait for Deployment'
    
    # é©—è­‰éƒ¨ç½²ç‹€æ…‹
    - task: AzureCLI@2
      displayName: 'Verify Deployment'
      inputs:
        azureSubscription: 'AUO-OpenAI-OpenAI-Service-ImageMeasure-Infra-Config-ADTEC3'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "Checking Container App status..."
          
          # æª¢æŸ¥ Container App ç‹€æ…‹
          status=$(az containerapp show \
            --name $(containerAppName) \
            --resource-group $(resourceGroupName) \
            --query "properties.provisioningState" \
            --output tsv)
          
          echo "Container App provisioning state: $status"
          
          if [ "$status" = "Succeeded" ]; then
            echo "âœ… Deployment verification successful"
            
            # å–å¾—æ‡‰ç”¨ç¨‹å¼ URL
            fqdn=$(az containerapp show \
              --name $(containerAppName) \
              --resource-group $(resourceGroupName) \
              --query "properties.configuration.ingress.fqdn" \
              --output tsv)
            
            if [ -n "$fqdn" ]; then
              echo "ğŸŒ Application URL: https://$fqdn"
              echo "ğŸ“Š You can now access the application at the above URL"
            else
              echo "âš ï¸ Could not retrieve application FQDN"
            fi
            
          else
            echo "âŒ Deployment verification failed - Container App status: $status"
            exit 1
          fi